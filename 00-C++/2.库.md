# åº“

## ä»€ä¹ˆæ˜¯åº“ï¼Ÿ

å°±åƒæ‚¨ä½¿ç”¨å›¾ä¹¦é¦†ä¸­ä¿å­˜çš„ä¹¦ç±ï¼ˆçœŸå®ä¹¦ç±ï¼‰ä¸­çš„ä¿¡æ¯ä¸€æ ·ã€‚åœ¨ç¼–ç¨‹ä¸­ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨æ¥è‡ªå…¶ä»–ä½œè€…æˆ–ç¤¾åŒºçš„å®ç°çŸ¥è¯†ï¼ˆå‡½æ•°/ä¾‹ç¨‹ï¼‰ã€‚é‡ç”¨åˆ«äººçš„ä»£ç æ¥é¿å…é‡æ–°å®ç°çš„æ—¶é—´æ˜¯ä¸€ä»¶å¾ˆé…·çš„äº‹æƒ…ã€‚å®ƒè®©æ‚¨ä¸“æ³¨äºåº”ç”¨ç¨‹åºçš„é€»è¾‘è€Œä¸æ˜¯å®ç”¨ç¨‹åº

å˜é‡å’Œå‡½æ•°æœ‰ä¸¤éƒ¨åˆ†ï¼šåŸå‹è®¾è®¡å’Œå®šä¹‰ã€‚

åœ¨åŸå‹è®¾è®¡çš„æƒ…å†µä¸‹ï¼Œæ‚¨åŸºæœ¬ä¸Šåˆ›å»ºæ ‡è¯†ç¬¦çš„ç­¾åå¹¶æ³¨å†Œå…¶åç§°ã€è¿”å›ç±»å‹å’Œå‚æ•°ï¼ˆ*å½“æ‚¨ä¼ é€’å€¼æ—¶ï¼Œå®ƒè¢«ç§°ä¸ºå‚æ•°ï¼Œè€Œåœ¨å‡½æ•°ä¸­æ¥å—å®ƒä»¬è¢«ç§°ä¸ºå‚æ•°ï¼‰*

```cpp
void greet(std::string name);
```

å¯¹åä¸º***greetçš„å‡½æ•°è¿›è¡ŒåŸå‹è®¾è®¡***

å®šä¹‰æ˜¯æ‚¨å®é™…å®ç°å‡½æ•°æˆ–å˜é‡çš„ä»£ç ï¼ˆä¹Ÿç§°ä¸º*åˆå§‹åŒ–*ï¼‰ã€‚åœ¨æ­¤é˜¶æ®µï¼Œæ‚¨å¿…é¡»ä½¿ç”¨åœ¨åŸå‹è®¾è®¡æ—¶é€‰æ‹©çš„æ ‡è¯†ç¬¦çš„ç›¸åŒè¯­æ³•ã€‚

```cpp
void greet(std::string name) {
	std::cout << "Hello, " << name << std::endl;
}
```

ä»¥åç§°ä¸ºå‚æ•°è°ƒç”¨ greet å‡½æ•°æ—¶è¦æ‰§è¡Œçš„å®ç°æŒ‡ä»¤

ä¸€äº›èµ„æ·±çš„ C++ å¼€å‘äººå‘˜ï¼Œæœ‰æ—¶ä¹Ÿå°†åŸå‹ç§°ä¸ºæ ‡è¯†ç¬¦ç­¾åã€‚

å› æ­¤ï¼Œè¯¥åº“åŒ…å«åœ¨ç›¸åº”å¤´æ–‡ä»¶ä¸­åŸå‹åŒ–çš„è¿™äº›æ ‡è¯†ç¬¦çš„å®šä¹‰ã€‚ä¾‹å¦‚ï¼Œæ‚¨ä½¿ç”¨åœ¨åº“`cmath`ä¸­å®šä¹‰çš„å¤´æ–‡ä»¶ä¸­çš„å‡½æ•°ã€‚`libm`åœ¨ GCC ä¸­ï¼Œæ‚¨å¯ä»¥è¿™æ ·åšï¼Œ

```bash
gcc arithmatic.c -lm -o arithmatic
```

ä½¿ç”¨åº“ç¼–è¯‘ç¨‹åº`libm.so`

è¿™é‡Œ`-lm`çš„æ„æ€æ˜¯åŒ…å«`libm.so`æ–‡ä»¶å¹¶æä¾›å‡½æ•°çš„å®šä¹‰ã€‚å¥½å§ï¼Œæˆ‘ä»¬ä¸ä¼šåœ¨ Windows ç¯å¢ƒä¸­ä½¿ç”¨ GCCã€‚

ç”±äºåº“çš„ä»£ç å¾ˆå°‘æ›´æ”¹ï¼Œå› æ­¤æ¯æ¬¡æ‚¨ç‚¹å‡» Build æŒ‰é’®å¹¶æä¾›å¿«é€Ÿç¼–è¯‘æ—¶ï¼Œå®ƒä»¬éƒ½ä¸ä¼šé‡æ–°ç¼–è¯‘ã€‚

## ä¸åŒç±»å‹çš„åº“

ç¨‹åºä¸­å¯ä»¥ä½¿ç”¨ä¸¤ç§ç±»å‹çš„åº“ã€‚

- é™æ€åº“
- å…±äº«åº“

é™æ€åº“ ( `.lib`) åŒ…å«é“¾æ¥å¹¶*åµŒå…¥*åœ¨å¯æ‰§è¡Œæ–‡ä»¶ä¸­çš„å®šä¹‰ã€‚å› æ­¤ï¼Œå®ƒä»¬ä½¿æ‚¨çš„å¯æ‰§è¡Œæ–‡ä»¶å¯ç§»æ¤ä¸”ä½“ç§¯åºå¤§ã€‚å¦‚æœæ‚¨è°ƒç”¨å¯æ‰§è¡Œæ–‡ä»¶*n*æ¬¡ï¼Œè¯¥åº“å°†ä¸å†…å­˜ä¸­çš„ä»£ç ä¸€èµ·åŠ è½½*næ¬¡ã€‚*æ­¤å¤–ï¼Œå¦‚æœæ‚¨å¿…é¡»æ›´æ–°é™æ€åº“ä¸­çš„ä»£ç ï¼Œåˆ™éœ€è¦ç¼–è¯‘ä¾èµ–é¡¹çš„æºä»£ç ã€‚

å…±äº«åº“ä¹Ÿç§°ä¸º*åŠ¨æ€é“¾æ¥åº“*ï¼ˆåˆç§° DLLï¼‰ï¼Œä¹ŸåŒ…å«ç›¸åŒçš„ä»£ç å®šä¹‰ï¼Œä½†ä¸é™æ€åº“ä¸åŒçš„æ˜¯ï¼Œå®ƒä»¬æ²¡æœ‰åµŒå…¥åˆ°ä»£ç ä¸­ã€‚å®ƒåœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶åœ¨å†…å­˜ä¸­åŠ è½½ä¸€æ¬¡ï¼Œä¹‹åè¢«ä»£ç é‡ç”¨ã€‚è¿™ä¸æˆ‘ä»¬è®¨è®ºè¿‡çš„é™æ€åº“çš„æ‰€æœ‰è§‚ç‚¹èƒŒé“è€Œé©°ã€‚

ä» DLL è°ƒç”¨å‡½æ•°æœ‰ä¸¤ç§æ–¹æ³•

- åŠ è½½æ—¶é—´é“¾æ¥
- è¿è¡Œæ—¶é“¾æ¥

æ‰€ä»¥åŸºæœ¬ä¸Šåœ¨è¿è¡Œæ—¶é“¾æ¥ä¸­ï¼Œæ‚¨é¦–å…ˆåŠ è½½åº“ï¼Œç„¶åè°ƒç”¨å‡½æ•°ä»¥è·å–å¯¼å‡ºå‡½æ•°çš„åœ°å€å¹¶åƒæ™®é€šå‡½æ•°ä¸€æ ·è°ƒç”¨å®ƒã€‚åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†ä¸“æ³¨äºè¿è¡Œæ—¶é“¾æ¥ã€‚æ‚¨å¯ä»¥ä»[è¿™ç¯‡æ–‡ç« ä¸­äº†è§£å…¶ä»–äºº](https://docs.microsoft.com/en-us/windows/win32/dlls/about-dynamic-link-libraries#types-of-dynamic-linking)

**æ³¨æ„ â€“**å°½ç®¡åŠ è½½æ—¶é“¾æ¥æ¯”è¿è¡Œæ—¶æ›´å¿«ï¼Œå› ä¸ºå®ƒä¼˜åŒ–äº†***GetProcAddress\***çš„è°ƒç”¨ï¼Œä½†å½“åº”ç”¨ç¨‹åºçš„å¯åŠ¨æ€§èƒ½å¾ˆé‡è¦æ—¶ï¼Œè¿è¡Œæ—¶åŠ¨æ€é“¾æ¥æ›´å¯å–ã€‚

### ä½†æ˜¯æˆ‘çš„ DLL åœ¨å“ªé‡Œï¼Ÿ

å’Œä½ ä¸€æ ·ï¼Œæˆ‘å¿ƒé‡Œä¹Ÿæœ‰è¿™ä¸ªé—®é¢˜ã€‚ç¨‹åºåœ¨åŠ è½½æ—¶å¦‚ä½•æŸ¥æ‰¾åŠ¨æ€åº“ï¼Œå¦‚æœåœ¨ä»»ä½•åœ°æ–¹éƒ½æ‰¾ä¸åˆ°æ€ä¹ˆåŠï¼Ÿæ‚¨ä½•æ—¶æ‰§è¡Œ`**LoadLibrary**`å‘¼å«ï¼ˆæˆ‘ä¼šè§£é‡Šï¼‰ã€‚å®ƒå°†æŒ‰ç…§[æ­¤å¤„](https://docs.microsoft.com/en-us/windows/win32/dlls/dynamic-link-library-search-order#standard-search-order-for-desktop-applications)æ‰€è¿°çš„ä»¥ä¸‹é¡ºåºæœç´¢ DLL æ–‡ä»¶çš„åç§°ã€‚

æ³¨æ„ä¸€ä»¶äº‹ï¼Œå®‰å…¨æ¨¡å¼ï¼Ÿå¦‚æœæ‚¨ç¡®å®ç¦ç”¨äº† DLL æœç´¢å®‰å…¨æ¨¡å¼ï¼Œæ”»å‡»è€…å¯ä»¥è¿›è¡Œ DLL[æœç´¢é¡ºåºåŠ«æŒ](https://www.contextis.com/en/blog/dll-search-order-hijacking)ï¼Œç¨‹åºå°†åŠ è½½ä»–ä»¬çš„æ¶æ„ DLLï¼Œæœ€ç»ˆæ¥ç®¡ç³»ç»Ÿçš„æ§åˆ¶æƒã€‚

å¦‚æœæŒ‰ä¸Šè¿°é¡ºåºæ‰¾ä¸åˆ° dllï¼Œ**LoadLibrary**å°†è¿”å›`NULL`. æ‰€ä»¥ä½ å¯ä»¥æ·»åŠ ä¿éšœã€‚

```cpp
HMODULE hLib = LoadLibrary(L"MyLibrary");

if (hLib == NULL) {
	std::wcerr << "Library MyLibrary.dll not found" << std::endl;
	exit(1);
}
```

æ£€æŸ¥æ˜¯å¦`LoadLibraryA`æ‰¾åˆ°ç›®æ ‡åº“

## ç”¨ C++ ç¼–å†™ DLL

åœ¨è¿™ä¸ªæ¼”ç¤ºä¸­ï¼Œæˆ‘å°†åˆ›å»ºä¸€ä¸ªæ‰§è¡Œ*åŠ æ³•ã€å‡æ³•ã€é™¤æ³•*å’Œ*ä¹˜æ³•çš„ç®€å•ç®—æœ¯ Dllã€‚*æ˜¯çš„ï¼Œå¤ªå¤©çœŸäº†ã€‚è¿™ä¸ä»…æœ‰åŠ©äºå­¦ä¹ å¦‚ä½•åŠ è½½åº“ï¼Œè¿˜æœ‰åŠ©äºå­¦ä¹ å®ƒä»¬æ˜¯å¦‚ä½•åˆ›å»ºçš„ã€‚

### DLL å…¥å£ç‚¹ ( `DllMain`)

ä¸æ™®é€šçš„ C++ ç¨‹åºä¸€æ ·ï¼ŒDLL ä¹Ÿæœ‰ä¸€ä¸ªå…¥å£ç‚¹ï¼Œç§°ä¸º`DllMain`å®ƒå°†åœ¨ Dll æ–‡ä»¶åŠ è½½æˆ–å¸è½½åˆ°æ­£åœ¨è¿è¡Œçš„ç¨‹åº/çº¿ç¨‹æ—¶æ‰§è¡Œã€‚

```cpp
BOOL WINAPI DllMain(
    HINSTANCE hinstDLL,  // handle to DLL module
    DWORD fdwReason,     // reason for calling function
    LPVOID lpReserved )  // reserved
{
    // Perform actions based on the reason for calling.
    switch( fdwReason ) 
    { 
        case DLL_PROCESS_ATTACH:
         // Initialize once for each new process.
            break;

        case DLL_THREAD_ATTACH:
         // Do thread-specific initialization.
            break;

        case DLL_THREAD_DETACH:
         // Do thread-specific cleanup.
            break;

        case DLL_PROCESS_DETACH:
         // Perform any necessary cleanup.
            break;
    }
    
    // Successful. If this is FALSE, the process will be terminated eventually
    // https://docs.microsoft.com/en-us/windows/win32/dlls/dynamic-link-library-entry-point-function#entry-point-function-return-value
    return TRUE;  
}
```

DllMain æ˜¯ç‰¹å®š DLL åŠ è½½åˆ°è¿›ç¨‹å†…å­˜æ—¶çš„å…¥å£å‡½æ•°

ä½†ä¸`main`C++ ä»£ç ä¸­çš„å‡½æ•°ä¸åŒï¼Œæ­¤å‡½æ•°æ˜¯å¯é€‰çš„ã€‚å¦‚æœå­˜åœ¨ï¼Œåˆ™åªè¦è¿›ç¨‹æˆ–çº¿ç¨‹åŠ è½½æˆ–å¸è½½ DLLï¼Œç³»ç»Ÿå°±ä¼šè°ƒç”¨å…¥å£ç‚¹å‡½æ•°ã€‚åœ¨è¿™ä¸ªé¡¹ç›®ä¸­ï¼Œæˆ‘ä½¿ç”¨äº†`**DllMain**`åœ¨æ§åˆ¶å°ä¸Šæ‰“å°æ–‡æœ¬çš„åŠŸèƒ½ï¼Œä½ å¯ä»¥[åœ¨è¿™é‡ŒæŸ¥çœ‹](https://github.com/tbhaxor/Win-LoadLibrary/blob/main/MyDLL/dllmain.cpp#L8-L31)

### DLL å‡½æ•°

ç°åœ¨æ˜¯æ—¶å€™åœ¨[æ­¤å¤„](https://github.com/tbhaxor/Win-LoadLibrary/blob/main/MyDLL/dllmain.cpp#L36-L50)çš„ DLL æºæ–‡ä»¶ä¸­æ·»åŠ æˆ‘ä»¬çš„å‡½æ•°äº†ã€‚æ‚¨å¯ä»¥æŸ¥çœ‹ä»¥ä¸‹å†…å®¹ã€‚

```c
EXTERN_C DWORD AddFunc(DWORD x, DWORD y) {
    return x + y;
}

EXTERN_C DWORD SubFunc(DWORD x, DWORD y) {
    return x - y;
}

EXTERN_C DWORD DivFunc(DWORD x, DWORD y) {
    return x / y;
}

EXTERN_C DWORD ProFunc(DWORD x, DWORD y) {
    return x * y;
}
```

åœ¨ä¸­ç¼–å†™å‡½æ•°çš„å®šä¹‰`DllMain`å¹¶å°†å…¶å¯¼å‡º

å®ƒæ€»æ˜¯æ‰“ç®—åœ¨ C å’Œ C++ ä¸­ä½¿ç”¨åº“ï¼Œä½ å¯ä»¥è¯´æ˜¯å‘åå…¼å®¹ã€‚`EXTERN_C`è¿™æ˜¯ä¸€ä¸ªå®ï¼Œåªæœ‰å½“åº“ä»£ç æ˜¯ä» C++ ç¼–è¯‘å™¨ç¼–è¯‘æ—¶ï¼Œæ‰ä¼š`extern "C"`åœ¨ç¼–è¯‘æ—¶è§£æä¸ºï¼ˆ[æ¥è‡ª wine çš„æºä»£ç ï¼‰ã€‚](https://github.com/wine-mirror/wine/blob/master/include/winnt.h#L442)

ç°åœ¨è®©æˆ‘ä»¬ä¸ºè¦åœ¨ C++ ä»£ç ä¸­ç”¨äºç±»å‹è½¬æ¢çš„å‡½æ•°åˆ›å»ºä¸€ä¸ªç­¾åï¼Œæˆ‘ä»¬å°†åœ¨å…¶ä¸­ä½¿ç”¨è¿™ä¸ª DLLã€‚åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘å°†åˆ›å»º 4 ä¸ªå‡½æ•°æ¥æ‰§è¡Œç®—æœ¯è¿ç®—ã€‚

```c
#pragma once
#include <Windows.h>

typedef DWORD(*AddFunc)(DWORD, DWORD);
typedef DWORD(*DivFunc)(DWORD, DWORD);
typedef DWORD(*SubFunc)(DWORD, DWORD);
typedef DWORD(*ProFunc)(DWORD, DWORD);
```

å°†ç”± DLL å¯¼å‡ºçš„å‡½æ•°çš„ç­¾å

C++ ä¸­çš„è¿™ç§è¯­æ³•ç§°ä¸ºå‡½æ•°æŒ‡é’ˆï¼Œå®ƒå…è®¸æ‚¨å°†å‡½æ•°ä½œä¸ºå‚æ•°ä¼ é€’æˆ–å°†å®ƒä»¬ä½œä¸ºå€¼è¿”å›ã€‚å®ƒæ˜¯é«˜çº§è¯­è¨€ï¼ˆå¦‚ python æˆ– javascriptï¼‰ä¸­æ‰€è°“çš„â€œlambda å‡½æ•°â€çš„åŸºç¡€ã€‚å½“åº”ç”¨ç¨‹åºåŠ è½½åˆ°å†…å­˜ä¸­æ—¶ï¼Œæ‚¨æ‰€éœ€è¦çš„åªæ˜¯å¯¹å…¶å†…å­˜ä½ç½®çš„å¼•ç”¨å’Œ`([variables...])`æ‰§è¡Œè¯¥æŒ‡ä»¤é›†çš„è¯­æ³•ã€‚è¿™äº›å‡½æ•°ç­¾åå°†ç”¨äºç±»å‹è½¬æ¢ä¸€ä¸ªåœ°å€ï¼Œæ‚¨å¯ä»¥åœ¨å–æ¶ˆå¼•ç”¨ä»å‡½æ•°è·å¾—çš„æŒ‡é’ˆæ—¶è°ƒç”¨æ™®é€š`**GetProcAddress**`å‡½æ•°

**æ³¨æ„ï¼šâ€“**ç”±äºæ‰€æœ‰å‡½æ•°éƒ½å…·æœ‰ç›¸åŒçš„ç­¾åï¼Œå¸¦æœ‰ä¸¤ä¸ªç±»å‹çš„å‚æ•°ï¼Œ`DWORD`å¹¶ä¸”è¿”å›ç±»å‹ä¹Ÿæ˜¯`DWORD`. å®é™…ä¸Šï¼Œæ‚¨åªèƒ½æ‹¥æœ‰ä¸€ä¸ªå‡½æ•°ï¼ˆå¦‚ä¸‹æ‰€ç¤ºï¼‰å¹¶å¯ä»¥ä»»æ„å‘½åã€‚è¿™äº›åç§°ä»…ä¾›æ‚¨ç†è§£ã€‚å®é™…ä¸Šï¼Œå®ƒä¼šä»å‡½æ•°çš„åœ°å€å¼€å§‹æ‰§è¡ŒæŒ‡ä»¤ã€‚ä½†æ˜¯ä¸ºäº†å­¦ä¹ çš„ç›®çš„ï¼Œæˆ‘ä¼šåšæŒä¸Šé¢çš„è¯­æ³•

```c
#pragma once
#include <Windows.h>

typedef DWORD(*Arithmetic)(DWORD, DWORD);
```

å¯¼å‡ºå‡½æ•°ç­¾åçš„ç®€åŒ–ç‰ˆæœ¬

### å¯¼å‡º DLL å‡½æ•°

åœ¨åº“æºä»£ç ä¸­ç¼–å†™å‡½æ•°åï¼Œéœ€è¦ä½¿ç”¨æ¨¡å—å®šä¹‰æ–‡ä»¶å°†å…¶å¯¼å‡ºï¼Œè¯¥æ–‡ä»¶å‘Šè¯‰é“¾æ¥å™¨å¯ä»¥åœ¨åº”ç”¨ç¨‹åºæºä»£ç ä¸­ä½¿ç”¨çš„å‡½æ•°ã€‚è¿™åº”è¯¥é€šè¿‡**`Source.def`**åœ¨é¡¹ç›®ä¸­åˆ›å»ºä¸€ä¸ªæ–‡ä»¶å¹¶åœ¨*é“¾æ¥å™¨è®¾ç½®*ä¸­é…ç½®å®ƒæ¥å®Œæˆï¼Œå¦‚ä¸‹æ‰€ç¤º

![img](https://tbhaxor.com/content/images/2021/11/image-120.png)`**.def**`åœ¨é¡¹ç›®å±æ€§ä¸‹çš„é“¾æ¥é€‰é¡¹ä¸­æŒ‡å®šæ–‡ä»¶

è¿˜æœ‰å¦ä¸€ç§æ–¹æ³•å¯ä»¥ä½¿ç”¨ï¼ˆå¦‚ä¸‹æ‰€ç¤ºï¼‰å¯¼å‡ºå‡½æ•°ã€‚æˆ‘æ›´å–œæ¬¢ä½¿ç”¨æ¨¡å—å®šä¹‰ï¼Œå› ä¸ºå®ƒä»¬æ˜¯ä¸€ç§æ›´ç®€æ´çš„é…ç½®æ–¹å¼ã€‚

```c
__declspec(dllexport) void Function1(void);
```

å‘Šè¯‰é“¾æ¥å™¨åº“æ­£åœ¨å¯¼å‡º`**Function1**`

æœ€åï¼Œåœ¨ Visual Studio ä¸­**åˆ›å»º DLL**çš„ä¸€åˆ‡éƒ½å·²å®ŒæˆğŸ¤©ï¼æ‚¨ç°åœ¨éœ€è¦åšçš„å°±æ˜¯ç¼–è¯‘ã€‚ç°åœ¨è®©æˆ‘ä»¬ç»§ç»­åœ¨ C++ ä»£ç ä¸­ä½¿ç”¨å®ƒã€‚

### åœ¨ C++ ä»£ç ä¸­ä½¿ç”¨ DLL ä¸­çš„å‡½æ•°

ç°åœ¨æ˜¯é«˜æ½®ï¼Œæˆ‘å°†å‘æ‚¨å±•ç¤ºå¦‚ä½•åŠ è½½ DLL å¹¶ä»ä¸­è°ƒç”¨å¯¼å‡ºçš„å‡½æ•°ã€‚æºä»£ç éå¸¸ç®€å•ï¼Œå¯ä»¥åœ¨**`Source.cpp`**æ–‡ä»¶ä¸­æ‰¾åˆ°

ä»£ç ä»¥åœ¨ç¼–è¯‘æ—¶[`_tmain`](https://github.com/tbhaxor/Win-LoadLibrary/blob/main/DLLLoad/Source.cpp#L7)æ›¿æ¢ä¸ºçš„å‡½æ•°å¼€å¤´ï¼Œ`wmain`ç”¨äºåœ¨åº”ç”¨ç¨‹åºä¸­å¤„ç† UNICODE å­—ç¬¦ä¸²ã€‚ç„¶åï¼Œæˆ‘æ·»åŠ äº†æ£€æŸ¥ä»¥å¤„ç†ä¼ é€’ç»™åº”ç”¨ç¨‹åºçš„æ— æ•ˆ CLI å‚æ•°å¹¶å°†å…¶è½¬æ¢ä¸º`LPWCSTR`ï¼Œ[å¦‚ä¸‹](https://github.com/tbhaxor/Win-LoadLibrary/blob/main/DLLLoad/Source.cpp#L8-L15)`DWORD`æ‰€ç¤ºã€‚æ‰€ä»¥åº”ç”¨ç¨‹åºæºä»£ç çš„åŸºæœ¬æ¨¡æ¿å¦‚ä¸‹æ‰€ç¤º

```c
#include <Windows.h>
#include <tchar.h>
#include <libloaderapi.h>
#include <wchar.h>
#include "../MyDLL/Header.h"

int _tmain(DWORD argc, LPTSTR* argv) {
	if (argc < 4) {
		_tprintf(_T("usage: %ws <x> <y> <add|div|prod|sub>\n"), argv[0]);
		return 1;
	}

	// convert TCHAR* to DWORD
	DWORD dwX = _wtoi(argv[1]);
	DWORD dwY = _wtoi(argv[2]);
    
    // add more code here
}
```

C++ç®—æœ¯è®¡ç®—ä»£ç æ¨¡æ¿

ç°åœ¨æ‚¨éœ€è¦é¦–å…ˆä½¿ç”¨`LoadLibrary`åœ¨æ ‡é¢˜ä¸­å®šä¹‰`libloaderapi.h`å¹¶åˆ«åä¸º`LoadLibraryW`using`#define`å®çš„å‡½æ•°åŠ è½½åº“ã€‚å®ƒåªæ¥å—ä¸€ä¸ªå‚æ•°ï¼šä¸€ä¸ªæŒ‡å‘å®½å­—ç¬¦ä¸²çš„é•¿æŒ‡é’ˆä½œä¸ºåº“çš„æ–‡ä»¶åã€‚

```c
HMODULE LoadLibraryW(
  [in] LPCWSTR lpLibFileName
);
```

å¤´æ–‡ä»¶ä¸­çš„`LoadLibraryW`å‡½æ•°ç­¾å`libloaderapi.h`

ä½œä¸ºå›æŠ¥ï¼Œå®ƒå°†ä¸ºæ‚¨æä¾›æ˜ å°„åˆ°å½“å‰è¿›ç¨‹è™šæ‹Ÿåœ°å€çš„ DLL æ¨¡å—çš„å¥æŸ„ã€‚å¦‚æœè¿™ä¸ªå¥æŸ„å€¼æ˜¯æˆ–è€…`NULL`ä½ `INVALID_HANDLE_VALUE`å¯ä»¥ä½œä¸ºè¿›ä¸€æ­¥å¤„ç†çš„ä¿éšœã€‚

```c
HMODULE hDll = LoadLibrary(_T("MyDLL"));
if (!hDll || hDll == INVALID_HANDLE_VALUE) {
	_tprintf(_T("unable to load libraray"));
	return 1;
}
```

ä»æœç´¢é¡ºåºåŠ è½½å¹¶éªŒè¯ DLL åº“

æˆåŠŸåŠ è½½åº“åï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä»£ç è·å–å…¶åœ°å€

```c
_tprintf(_T("library loaded at 0x%x\n"), hDll);
```

æ‰“å°Dllå¥æŸ„çš„åœ°å€

æœ€åï¼Œç°åœ¨æ˜¯æ—¶å€™è·å– DLL ä¸­å‡½æ•°çš„å¼•ç”¨å¹¶ä½¿ç”¨æ­£å¸¸çš„å‡½æ•°è°ƒç”¨æ¥æ‰§è¡Œå®ƒäº†ã€‚å‡½æ•°çš„åœ°å€å¯ä»¥é€šè¿‡å¤´æ–‡ä»¶ä¸­çš„`**GetProcAddress**` å‡½æ•°è·å¾—ï¼Œè¯¥å‡½æ•°`libloaderapi.h`æ¥å—ä¸¤ä¸ªå‚æ•°ï¼šDLLå¥æŸ„å’Œå¯¼å‡ºå‡½æ•°çš„åç§°ã€‚å¦‚æœå‡½æ•°æˆåŠŸï¼Œå®ƒå°†è¿”å›å¯¼å‡ºå‡½æ•°çš„åœ°å€ã€‚

```c
FARPROC GetProcAddress(
  [in] HMODULE hModule,
  [in] LPCSTR  lpProcName
);
```

å¤´æ–‡ä»¶ä¸­çš„`GetProcAddress`å‡½æ•°ç­¾å`libloaderapi.h`

è·å¾—åœ°å€åï¼Œæ‚¨éœ€è¦è°ƒç”¨è¯¥å‡½æ•°ï¼Œå¹¶ä¸”å®ƒæ˜¯åœ¨å½“å‰é¡¹ç›®ä¸­å®šä¹‰çš„`**Add(dwX, dwY)**`**ã€‚**

```c
AddFunc Add = (AddFunc)GetProcAddress(hDll, "AddFunc");
if (!Add) _tprintf(_T("unable to load AddFunc\n"));
else _tprintf(_T("%d + %d = %d\n"), dwX, dwY, Add(dwX, dwY));
```

åŠ è½½**`AddFunc`ã€**è½¬æ¢ä¸ºé€‚å½“çš„ç±»å‹å¹¶ä½¿ç”¨å¸¦å‚æ•°çš„å‡½æ•°è°ƒç”¨

åœ¨æ„å»ºé¡¹ç›®ä¹‹å‰ï¼Œéœ€è¦å°† DLL æ·»åŠ åˆ°å¼•ç”¨ä¸­ã€‚æ‚¨å¯ä»¥é€šè¿‡åœ¨è§£å†³æ–¹æ¡ˆèµ„æºç®¡ç†å™¨ä¸­é€‰æ‹©**å¼•ç”¨**å¹¶é€‰æ‹©`MyDLL`é¡¹ç›®æ¥å®Œæˆæ­¤æ“ä½œã€‚

![img](https://tbhaxor.com/content/images/2021/12/image.png)å¼•ç”¨`DLLLoad`é¡¹ç›®ä¸­çš„åº“

æœ€åï¼Œå½“ä¸€åˆ‡éƒ½å®Œæˆå¹¶ä¸”ä¸å†éœ€è¦ DLL æ—¶ï¼Œæ‚¨éœ€è¦[**`FreeLibrary`**](https://docs.microsoft.com/en-us/windows/desktop/api/libloaderapi/nf-libloaderapi-freelibrary)ä½¿ç”¨`libloaderapi.h`. å®ƒåªæ¥å—ä¸€ä¸ªå‚æ•°ï¼šåŠ è½½çš„ DLL æ¨¡å—çš„å¥æŸ„ï¼Œ`TRUE`å¦åˆ™è¿”å›æˆåŠŸ`FALSE`

```c
BOOL FreeLibrary(
  [in] HMODULE hLibModule
);
```

å¤´æ–‡ä»¶ä¸­çš„`FreeLibrary`å‡½æ•°ç­¾å`libloaderapi.h`

[æ‚¨å¯ä»¥åœ¨æ­¤å¤„](https://github.com/tbhaxor/Win-LoadLibrary/blob/main/DLLLoad/Source.cpp#L58)çš„ä¸»è¦åŠŸèƒ½çš„æœ€åä¸€ä¸ªä¸­æ‰¾åˆ°å®ƒå®ç°

```c
FreeLibrary(hDll);
```

åœ¨ä¸éœ€è¦æ—¶é‡Šæ”¾åŠ è½½çš„ DLL

# å‚è€ƒ

- https://docs.microsoft.com/en-us/cpp/build/dlls-in-visual-cpp?view=msvc-170
- https://github.com/wine-mirror/wine/blob/master/include/winnt.h#L442
- https://docs.microsoft.com/en-us/windows/win32/dlls/about-dynamic-link-libraries#types-of-dynamic-linking
- https://docs.microsoft.com/en-us/windows/win32/dlls/dynamic-link-library-search-order#standard-search-order-for-desktop-applications
- https://www.contextis.com/en/blog/dll-search-order-hijacking
- https://docs.microsoft.com/en-us/windows/win32/dlls/dllmain
- https://stackoverflow.com/questions/895827/what-is-the-difference-between-tmain-and-main-in-c
- https://www.pinvoke.net/default.aspx/Constants/INVALID_HANDLE_VALUE.html
- https://docs.microsoft.com/en-us/windows/win32/dlls/dllmain
- https://docs.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-getprocaddress
- https://docs.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibraryw
- https://docs.microsoft.com/en-us/cpp/build/exporting-from-a-dll-using-def-files?view=msvc-160
- https://docs.microsoft.com/en-us/cpp/cpp/extern-cpp?view=msvc-160
- https://docs.microsoft.com/en-us/windows/desktop/api/libloaderapi/nf-libloaderapi-freelibrary
